rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if user is Super Admin
    function isSuperAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().role == 'super_admin';
    }

    // Check if user is Admin (includes Super Admin)
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (getUserData().role == 'admin' || getUserData().role == 'super_admin');
    }

    // Check if user is Staff (includes all upper roles)
    function isStaff() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (
               getUserData().role == 'marketing' ||
               getUserData().role == 'doctor' ||
               getUserData().role == 'admin' ||
               getUserData().role == 'super_admin'
             );
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper to get tenant ID
    function getTenantId() {
      return getUserData().tenantId;
    }

    // ===========================================
    // SUPER ADMIN & PLATFORM (High Privilege)
    // ===========================================
    // --- Finance & Affiliate ---
    match /affiliate_transactions/{transId} {
      allow read: if request.auth != null && (resource.data.tenantId == getTenantId() || isSuperAdmin());
      allow write: if false; // Only Cloud Functions can write
    }

    match /invoices/{invoiceId} {
      allow read: if request.auth != null && (resource.data.tenantId == getTenantId() || isSuperAdmin());
      allow write: if false; // Only Cloud Functions
    }

    match /payout_requests/{reqId} {
      allow read: if request.auth != null && (resource.data.tenantId == getTenantId() || isSuperAdmin());
      allow create: if request.auth != null && request.resource.data.tenantId == getTenantId();
      allow update, delete: if isSuperAdmin();
    }

    match /platform_settings/finance {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }

    // --- Content Management (News, Services, etc.) ---
    // Tenants Management
    match /tenants/{tenantId} {
      // Allow public read access (Priority)
      allow read: if true;

      // Super Admin, Owner, or Admin can update (e.g. Booking, Branding)
      allow update: if isSuperAdmin() || 
                       (isAuthenticated() && resource.data.ownerId == request.auth.uid) || 
                       isAdmin();
      
      // Only Super Admin can delete a tenant
      allow delete: if isSuperAdmin();
      
      // Allow creating a new tenant during registration
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      
      // Tenant Settings (About, Contact, etc.)
      match /settings/{document=**} {
        allow read: if true;
        allow write: if isStaff();
      }
    }

    // Subscriptions
    match /subscriptions/{docId} {
      allow read, write: if isSuperAdmin();
      
      // Allow creating subscription during tenant registration
      allow create: if isAuthenticated();
      
      // Allow users to read their own subscription
      allow read: if isAuthenticated() && 
                     (docId == getUserData().tenantId || resource.data.tenantId == getUserData().tenantId);
    }

    // Platform Settings (Global)
    match /platform_settings/{document=**} {
      allow read: if isAuthenticated(); // All logged in users need to see maintenance mode etc
      allow write: if isSuperAdmin();
    }

    // Site Settings (Legacy single-tenant fallback)
    match /site_settings/{settingId} {
      allow read: if true; // Public read for branding
      allow write: if isAdmin();
    }

    // Subscription Plans
    match /subscription_plans/{document=**} {
      allow read: if true; // Public pricing
      allow write: if isSuperAdmin();
    }

    // Generic Settings (Legacy)
    match /settings/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Users
    match /users/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isStaff());
      
      // Allow creating own user document during registration
      allow create: if isAuthenticated() && userId == request.auth.uid;
      
      // Allow updating own user or admin updating others
      allow update: if isAuthenticated() && (isOwner(userId) || isAdmin());
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // Services (Tenant Isolated)
    match /services/{document=**} {
      allow read, write: if isStaff();
    }

    // ===========================================
    // CONTENT & MEDIA
    // ===========================================

    // AI Social Agent Posts
    match /social_posts/{document=**} {
      allow read, write: if isStaff();
    }

    // News & Blog Platform
    match /news/{document=**} {
      allow read: if true;
      allow write: if isStaff();
    }
    match /news_categories/{document=**} {
      allow read: if true;
      allow write: if isStaff();
    }
    match /news_tags/{document=**} {
      allow read: if true;
      allow write: if isStaff();
    }

    // Real Estate Products / Properties
    match /properties/{document=**} {
      allow read: if true;
      allow write: if isStaff();
    }
    
    // Project Landing Pages
    // Allowing write for staff so they can build pages
    match /landing_pages/{document=**} {
      allow read: if true;
      allow write: if isStaff();
    }

    // Legacy or Other Collections
    match /projects/{document=**} {
      allow read: if true;
      allow write: if isStaff();
    }
    match /ingredients/{document=**} {
      allow read: if true;
      allow write: if isStaff();
    }

    // ===========================================
    // BUSINESS TRANSATIONS & CRM
    // ===========================================

    // Orders (Financials, Bookings)
    match /orders/{document=**} {
      allow read, write: if isStaff();
    }

    // Appointments (Calendar/Bookings)
    match /appointments/{document=**} {
      allow read, write: if isStaff();
    }

    // Inquiries / Leads (Public Create, Staff Read)
    match /inquiries/{document=**} {
      allow create: if true;
      allow read, update, delete: if isStaff();
    }

    // Customers (CRM)
    match /customers/{document=**} {
      allow create: if true; // Allow leads from landing pages
      allow read, update, delete: if isStaff();
    }
    
    // ===========================================
    // SYSTEM & LOGS
    // ===========================================

    match /system_logs/{document=**} {
      allow read: if isStaff();
      allow create: if isStaff(); // Logs created by client interactions usually
      allow update, delete: if isAdmin(); // Only admin should delete logs
    }

    // Explicitly allow branding settings write
    match /settings/branding {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Default deny for safety (Catch-all)
    match /{document=**} {
      allow read, write: if isSuperAdmin(); // Super Admin ultimate fallback
    }
  }
}